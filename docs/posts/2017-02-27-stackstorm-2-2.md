---
title: StackStorm 2.2 is up!
author: st2admin
type: post
date: 2017-02-27T20:38:58+00:00
url: /2017/02/27/stackstorm-2-2/
thrive_post_fonts:
  - '[]'
dsq_thread_id:
  - 5589433815
categories:
  - Blog
  - News
tags:
  - release
  - StackStorm

---
**Feb 27, 2017**  
_by Lindsay Hill_

Here&#8217;s a nice way to start your week: StackStorm 2.2 has been released! Mistral updates, Jinja in Mistral workflows, Jinja in complex objects, new `st2 login` and `st2 whoami` commands, security improvements and more! Our [release master][1] put in some hard work over the last few days to get this out the door. Read on for more details.

<!--more-->

## Jinja Enhancements

You asked, we&#8217;ve delivered: You can now use Jinja expressions in Mistral workflows, wherever YAQL expressions are accepted. This lets you do things like manipulate the input & output data structures, perform boolean logic, and and conditional logic for evaluating and transforming data. Each expression should be encapsulated with `{{ }}`. Here&#8217;s an example that shows how to work with environment variables:

<div id="gist45243034" class="gist">
  <div class="gist-file" translate="no">
    <div class="gist-data">
      <div class="js-gist-file-update-container js-task-list-container file-box">
        <div id="file-mistral-jinja-env-var-yaml" class="file my-2">
          <div itemprop="text" class="Box-body p-0 blob-wrapper data type-yaml  ">
            <table class="highlight tab-size js-file-line-container" data-tab-size="8" data-paste-markdown-skip>
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L1" class="blob-num js-line-number" data-line-number="1">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC1" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">version</span>: <span class="pl-s"><span class="pl-pds">'</span>2.0<span class="pl-pds">'</span></span>
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L2" class="blob-num js-line-number" data-line-number="2">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC2" class="blob-code blob-code-inner js-file-line">
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L3" class="blob-num js-line-number" data-line-number="3">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC3" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">examples.mistral-jinja-env-var</span>:
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L4" class="blob-num js-line-number" data-line-number="4">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC4" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">description</span>: <span class="pl-s">A basic workflow that illustrates how to get the workflow's env vars.</span>
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L5" class="blob-num js-line-number" data-line-number="5">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC5" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">type</span>: <span class="pl-s">direct</span>
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L6" class="blob-num js-line-number" data-line-number="6">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC6" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">output</span>:
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L7" class="blob-num js-line-number" data-line-number="7">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC7" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">env</span>: <span class="pl-s"><span class="pl-pds">"</span>{{ env() }}<span class="pl-pds">"</span></span>
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L8" class="blob-num js-line-number" data-line-number="8">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC8" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">url</span>: <span class="pl-s"><span class="pl-pds">"</span>{{ _.url }}<span class="pl-pds">"</span></span>
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L9" class="blob-num js-line-number" data-line-number="9">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC9" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">tasks</span>:
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L10" class="blob-num js-line-number" data-line-number="10">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC10" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">task1</span>:
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L11" class="blob-num js-line-number" data-line-number="11">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC11" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">action</span>: <span class="pl-s">core.local</span>
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L12" class="blob-num js-line-number" data-line-number="12">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC12" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">input</span>:
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L13" class="blob-num js-line-number" data-line-number="13">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC13" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">cmd</span>: <span class="pl-s"><span class="pl-pds">"</span>echo http://127.0.0.1:9101/executions/{{ env().st2_execution_id }}<span class="pl-pds">"</span></span>
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L14" class="blob-num js-line-number" data-line-number="14">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC14" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">publish</span>:
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L15" class="blob-num js-line-number" data-line-number="15">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC15" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">url</span>: <span class="pl-s"><span class="pl-pds">"</span>{{ task('task1').result.stdout }}<span class="pl-pds">"</span></span>
                </td>
              </tr>
              
              <tr>
                <td id="file-mistral-jinja-env-var-yaml-L16" class="blob-num js-line-number" data-line-number="16">
                </td>
                
                <td id="file-mistral-jinja-env-var-yaml-LC16" class="blob-code blob-code-inner js-file-line">
                  <span class="pl-ent">ctx</span>: <span class="pl-s"><span class="pl-pds">"</span>{{ env()['__actions']['st2.action']['st2_context'] }}<span class="pl-pds">"</span></span>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <div class="gist-meta">
      <a href="https://gist.github.com/LindsayHill/cf72d9e386c9519c2cddfc62eecd3b09/raw/17962189dced9964eb9c8fa5357debe8e378878c/mistral-jinja-env-var.yaml" style="float:right">view raw</a> <a href="https://gist.github.com/LindsayHill/cf72d9e386c9519c2cddfc62eecd3b09#file-mistral-jinja-env-var-yaml">mistral-jinja-env-var.yaml</a> hosted with &#10084; by <a href="https://github.com">GitHub</a>
    </div>
  </div>
</div>

Read the [docs][2], and check the [examples][3] for more info.

Also: You can now nest Jinja variables inside array and object types.

Don’t worry though: YAQL is not going anywhere. It’s still there, and will continue to have first-class support, for those need its power and type support.

## Mistral Updates

As you know, we use and contribute to the [OpenStack Mistral][4] service for complex workflows in StackStorm. With this release we’ve updated our fork to the latest master branch. We’ve been wanting to do this for a while, as it brings us stability improvements, weeds out some corner-case deadlocks, and delivers performance enhancements. Thanks to [Renat][5] and [all the crew][6] for the good work they’re doing.

## CLI Authentication helpers

Want to authenticate to ST2 using the CLI, but don&#8217;t like storing your password in plaintext in your config file? Check out the new [`st2 login`][7] command. This is an easy way to login and cache your authentication token. Just run `st2 login st2admin --password Ch@ngeMe`.

This also gives you a quick way to switch user. Need to check which user you&#8217;re logged in as? Use the new `st2 whoami` command to check!

## Security Hardening

We&#8217;ve been doing some housekeeping, and we&#8217;ve tightened our default settings used by our installer script:

  * MongoDB now only listens on localhost, and creates two new users `admin` and `stackstorm`. The `stackstorm` user only has access to the `st2` database.
  * RabbitMQ now only listens on localhost.
  * PostgreSQL only listens on localhost (this was already a default on some distributions).
  * Mistral now uses a random password for PostgreSQL authentication.

This further reduces the default attack surface. If you’re doing a manual install of StackStorm, be sure to read the new [Security section][8].

## Miscellaneous Fixes and Improvements

The usual collection of smaller changes:

  * Validation of trigger parameters and payloads is now available. You will need to enable the `system.validate_trigger_payload` and `system.validate_trigger_parameters` options to use it &#8211; it is disabled by default. Thanks to Hiroyasu Ohyama for the contribution.
  * We now support MongoDB 3.4. The installation script will still install 3.2 by default, but you are welcome to move to 3.4. In future we will make 3.4 the default version.
  * RPM packaging fixes: The logrotate and LDAP configurations will no longer be removed on RPM upgrade.
  * `st2 pack install` will now work with git repositories that do not use `master` as the default branch.

## Upgrade Warnings

We previously warned that the `system` and `user` Jinja variable notation for accessing system and user scoped datastore items inside workflows and actions is going away and be replaced by the new `st2kv.system` and `st2kv.user` notation.

Well, that time has arrived. Now you really do need to update your actions and workflows to use the new scoping notation.

The database schema for Mistral has changed. The `executions_v2` table is no longer used. The table has been broken down into `workflow_executions_v2`, `task_executions_v2`, and `action_executions_v2`. There is currently no migration script to move existing records from executions\_v2 into the new tables. If you really need to read from executions\_v2, either use psql or install an older version of the python-mistralclient.

As always, full changelogs are [here][9], full upgrade notes are [here][10], and we are always available to help on our [Slack channel][11]. Sign up [here][12].

 [1]: https://github.com/Mierdin
 [2]: https://docs.stackstorm.com/mistral_jinja.html
 [3]: https://github.com/StackStorm/st2/tree/master/contrib/examples/actions/workflows/
 [4]: https://wiki.openstack.org/wiki/Mistral
 [5]: https://github.com/rakhmerov
 [6]: https://github.com/openstack/mistral/graphs/contributors
 [7]: https://docs.stackstorm.com/reference/cli.html?highlight=whoami#authentication-and-auth-token-caching
 [8]: https://docs.stackstorm.com/install/deb.html#a-note-on-security
 [9]: https://docs.stackstorm.com/changelog.html#february-22-2017
 [10]: https://docs.stackstorm.com/upgrade_notes.html
 [11]: https://stackstorm-community.slack.com
 [12]: https://stackstorm.com/community-signup