<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Watching the watcher: How to test and debug rules and trace what StackStorm does with triggers? | StackStorm</title>
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="February 4. 2016
By Manas Kelshikar
We have always wanted StackStorm to be much more transparent than older run book automation systems so that users trust it – so they allow StackStorm to do more and more of the work such as quashing 2am pages via auto-remediation.
Recently we’ve added some capabilities that further increase StackStorm’s transparency.
This post focuses on a few features that help follow the breadcrumbs of an event-driven automation. It specifically provides ways to answer the questions –


Why does this rule not work?
What did StackStorm do with the event that it received?


We will put these question in context of a StackStorm Auto-remediation. The example for this blog will use StackStorm to auto-remediate an application that at times has poor API response times. The cast for this plot will be StackStorm as the guardian and protector, Sensu as the watcher and an application that must be brought back to the light when it starts erring in its ways.
We will specifically demonstrate the use of st2-rule-tester as well as what we call Trace Tags. As always in these kinds of “tutorial” blogs – we include the actual StackStorm content.">
<meta name=generator content="Hugo 0.89.2">
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel=stylesheet href=/stackstorm.com/ananke/css/main.min.css>
<meta property="og:title" content="Watching the watcher:  How to test and debug rules and trace what StackStorm does with triggers?">
<meta property="og:description" content="February 4. 2016
By Manas Kelshikar
We have always wanted StackStorm to be much more transparent than older run book automation systems so that users trust it – so they allow StackStorm to do more and more of the work such as quashing 2am pages via auto-remediation.
Recently we’ve added some capabilities that further increase StackStorm’s transparency.
This post focuses on a few features that help follow the breadcrumbs of an event-driven automation. It specifically provides ways to answer the questions –


Why does this rule not work?
What did StackStorm do with the event that it received?


We will put these question in context of a StackStorm Auto-remediation. The example for this blog will use StackStorm to auto-remediate an application that at times has poor API response times. The cast for this plot will be StackStorm as the guardian and protector, Sensu as the watcher and an application that must be brought back to the light when it starts erring in its ways.
We will specifically demonstrate the use of st2-rule-tester as well as what we call Trace Tags. As always in these kinds of “tutorial” blogs – we include the actual StackStorm content.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://stackstorm.github.io/stackstorm.com/2016/02/04/watching-watcher-test-debug-rules-trace-stackstorm-triggers/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2016-02-05T01:06:02+00:00">
<meta property="article:modified_time" content="2016-02-05T01:06:02+00:00">
<meta itemprop=name content="Watching the watcher:  How to test and debug rules and trace what StackStorm does with triggers?">
<meta itemprop=description content="February 4. 2016
By Manas Kelshikar
We have always wanted StackStorm to be much more transparent than older run book automation systems so that users trust it – so they allow StackStorm to do more and more of the work such as quashing 2am pages via auto-remediation.
Recently we’ve added some capabilities that further increase StackStorm’s transparency.
This post focuses on a few features that help follow the breadcrumbs of an event-driven automation. It specifically provides ways to answer the questions –


Why does this rule not work?
What did StackStorm do with the event that it received?


We will put these question in context of a StackStorm Auto-remediation. The example for this blog will use StackStorm to auto-remediate an application that at times has poor API response times. The cast for this plot will be StackStorm as the guardian and protector, Sensu as the watcher and an application that must be brought back to the light when it starts erring in its ways.
We will specifically demonstrate the use of st2-rule-tester as well as what we call Trace Tags. As always in these kinds of “tutorial” blogs – we include the actual StackStorm content."><meta itemprop=datePublished content="2016-02-05T01:06:02+00:00">
<meta itemprop=dateModified content="2016-02-05T01:06:02+00:00">
<meta itemprop=wordCount content="1292">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Watching the watcher:  How to test and debug rules and trace what StackStorm does with triggers?">
<meta name=twitter:description content="February 4. 2016
By Manas Kelshikar
We have always wanted StackStorm to be much more transparent than older run book automation systems so that users trust it – so they allow StackStorm to do more and more of the work such as quashing 2am pages via auto-remediation.
Recently we’ve added some capabilities that further increase StackStorm’s transparency.
This post focuses on a few features that help follow the breadcrumbs of an event-driven automation. It specifically provides ways to answer the questions –


Why does this rule not work?
What did StackStorm do with the event that it received?


We will put these question in context of a StackStorm Auto-remediation. The example for this blog will use StackStorm to auto-remediate an application that at times has poor API response times. The cast for this plot will be StackStorm as the guardian and protector, Sensu as the watcher and an application that must be brought back to the light when it starts erring in its ways.
We will specifically demonstrate the use of st2-rule-tester as well as what we call Trace Tags. As always in these kinds of “tutorial” blogs – we include the actual StackStorm content.">
</head>
<body class="ma0 avenir bg-near-white">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a href=/stackstorm.com/ class="f3 fw2 hover-white no-underline white-90 dib">
StackStorm
</a>
<div class="flex-l items-center">
</div>
</div>
</nav>
</div>
</header>
<main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside class="instapaper_ignoref b helvetica tracked">
POSTS
</aside>
<div id=sharing class=mt3>
<a href="https://www.facebook.com/sharer.php?u=https://stackstorm.github.io/stackstorm.com/2016/02/04/watching-watcher-test-debug-rules-trace-stackstorm-triggers/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a href="https://twitter.com/share?url=https://stackstorm.github.io/stackstorm.com/2016/02/04/watching-watcher-test-debug-rules-trace-stackstorm-triggers/&text=Watching%20the%20watcher:%20%20How%20to%20test%20and%20debug%20rules%20and%20trace%20what%20StackStorm%20does%20with%20triggers?" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https://stackstorm.github.io/stackstorm.com/2016/02/04/watching-watcher-test-debug-rules-trace-stackstorm-triggers/&title=Watching%20the%20watcher:%20%20How%20to%20test%20and%20debug%20rules%20and%20trace%20what%20StackStorm%20does%20with%20triggers?" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div>
<h1 class="f1 athelas mt3 mb1">Watching the watcher: How to test and debug rules and trace what StackStorm does with triggers?</h1>
<p class=tracked>
By <strong>
st2admin
</strong>
</p>
<time class="f6 mv4 dib tracked" datetime=2016-02-05T01:06:02Z>February 5, 2016</time>
</header>
<div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p><strong>February 4. 2016</strong><br>
By Manas Kelshikar</p>
<p>We have always wanted StackStorm to be much more transparent than older run book automation systems so that users trust it – so they allow StackStorm to do more and more of the work such as quashing 2am pages via auto-remediation.</p>
<p>Recently we’ve added some capabilities that further increase StackStorm’s transparency.</p>
<p>This post focuses on a few features that help follow the breadcrumbs of an event-driven automation. It specifically provides ways to answer the questions –</p>
<blockquote>
<ul>
<li><strong>Why does this rule not work?</strong></li>
<li><strong>What did StackStorm do with the event that it received?</strong></li>
</ul>
</blockquote>
<p>We will put these question in context of a StackStorm Auto-remediation. The example for this blog will use StackStorm to auto-remediate an application that at times has poor API response times. The cast for this plot will be StackStorm as the guardian and protector, Sensu as the watcher and an application that must be brought back to the light when it starts erring in its ways.</p>
<p>We will specifically demonstrate the use of <code>st2-rule-tester</code> as well as what we call Trace Tags. As always in these kinds of “tutorial” blogs – we include the actual StackStorm content.</p>
<h2 id=the-setup>The Setup</h2>
<h3 id=pre-requisites>Pre-requisites</h3>
<ol>
<li>Install the latest version of StackStorm as per <a href=https://docs.stackstorm.com/install/all_in_one.html>these instructions</a>.</li>
<li>Install Sensu as per <a href=https://sensuapp.org/docs/0.21/installation-overview>these instructions</a>. It is recommended<br>
to keep StackStorm and Sensu on separate instances to isolate the services from each other.</li>
<li>An application that at times has poor API response times and with well understood remediation steps. In this blog we will use a custom <a href=https://github.com/manasdk/blog-dev/tree/master/api-latency-app>flask based python application</a> that satisfies this requirement.</li>
</ol>
<h3 id=configurations>Configurations</h3>
<ol>
<li>
<p>StackStorm is setup up with the <a href=https://github.com/StackStorm-Exchange/stackstorm-sensu>sensu pack.</a></p>
</li>
<li>
<p>Sensu is configured to <a href=https://github.com/StackStorm-Exchange/stackstorm-sensu#configure-sensu-to-send-events-to-stackstorm>send events to StackStorm.</a></p>
</li>
<li>
<p>Sensu setup with <a href=https://github.com/sensu/sensu-community-plugins/blob/master/plugins/http/check-http.rb>check-http.rb</a> plugin.</p>
</li>
<li>
<p>Following <a href=https://sensuapp.org/docs/0.11/adding_a_check>check added in sensu server</a>
{
&ldquo;checks&rdquo;: {
&ldquo;app_response_check&rdquo;: {
&ldquo;handlers&rdquo;: [&ldquo;default&rdquo;, &ldquo;st2&rdquo;],
&ldquo;command&rdquo;: &ldquo;/etc/sensu/plugins/check-http.rb -u http://127.0.0.1:9999/square/10 -t 7&rdquo;,
&ldquo;interval&rdquo;: 60,
&ldquo;subscribers&rdquo;: [ &ldquo;app_server&rdquo; ]
}
}
}</p>
</li>
<li>
<p>StackStorm setup with a custom <a href=https://github.com/manasdk/blog-dev/tree/master/app_remediation>application remediation pack</a> specific to the sample application.</p>
</li>
</ol>
<p>Once the setup and configurations are in place, the application is started and Sensu monitoring is validated by consulting the Uchiwa dashboard. The application can be put in a bad state by running <code>curl -X POST http://APP_SERVER/bad/10</code>. Doing so will cause Sensu to recognize that the application is non-responsive and in turn an event is sent to StackStorm via the registered StackStorm event handler.</p>
<h2 id=now-back-to-the-original-questions>Now back to the original questions</h2>
<p>If all goes well StackStorm Auto-remediation will fire and fix the applications performance. However, at times things do not work as expected or it is necessary to track down what StackStorm did in response to an external event. Here is how those questions can be answered.</p>
<h3 id=why-does-this-rule-not-work>Why does this rule not work?</h3>
<p>Taking a step back, a rule comprises of –</p>
<ul>
<li>A trigger to handle</li>
<li>Some selection criteria</li>
<li>An action to execute</li>
</ul>
<p>Writing a StackStorm rule is a key step in setting up an event-driven automation. Often a non-working rule is symptomatic of using the wrong trigger reference or a bug in the selection criteria. In order to help debugging during rule development and even later if the payload of a Trigger changes StackStorm provides a command line tool <code>st2-rule-tester</code>.</p>
<p>Sample rule –</p>
<pre><code>---
  name: on_app_response_check
  description: Sample rule that dogfoods st2.
  pack: app_remediation
  trigger:
    type: sensu.event_handler
  criteria:
    trigger.check.name:
      pattern: &quot;app_response&quot;
      type: &quot;equals&quot;
    trigger.check.output:
      pattern: &quot;CheckHTTP CRITICAL*&quot;
      type: &quot;matchregex&quot;
    trigger.check.status:
      pattern: 2
      type: equals
  action:
    ref: &quot;app_remediation.remediate&quot;
    parameters:
      app_server_host: &quot;127.0.0.1&quot;
      app_server_port: &quot;9999&quot;
  enabled: true
</code></pre>
<p>Use <code>st2 trigger-instance list --trigger sensu.event_handler</code> to get a list of all the <code>sensu.event_handler</code> TriggerInstances in StackStorm. Pick a suitable TriggerInstance from the generated list to use with <code>st2-rule-tester</code>. Head over to <a href=https://docs.stackstorm.com/sensors.html>Triggers and Sensors</a> for a general discussion on Sensor, Triggers and dispatching TriggerInstances.</p>
<p>Sample TriggerInstance already in StackStorm with some details omitted –</p>
<pre><code>{
    &quot;id&quot;: &quot;569882f7aef3392a8c2a834d&quot;,
    &quot;occurrence_time&quot;: &quot;2016-01-15T05:26:15.730000Z&quot;,
    &quot;payload&quot;: {
        ...
        &quot;check&quot;: {
            ...
            &quot;name&quot;: &quot;app_response_check&quot;,
            ...
        },
        ...
    },
    &quot;trigger&quot;: &quot;sensu.event_handler&quot;
}
</code></pre>
<p>Using <code>st2-rule-tester</code> to debug –</p>
<pre><code># st2-rule-tester --rule=/opt/stackstorm/packs/app_remediation/rules/on_app_response_check.yaml --trigger-instance-id=569882f7aef3392a8c2a834d --config-file=/etc/st2/st2.conf
2016-01-18 17:14:03,338 INFO [-] Connecting to database &quot;st2&quot; @ &quot;0.0.0.0:27017&quot; as user &quot;None&quot;.
2016-01-18 17:14:03,391 INFO [-] Validating rule app_remediation.on_app_response_check for event_handler.
2016-01-18 17:14:03,430 INFO [-] Validation for rule app_remediation.on_app_response_check failed on criteria -
  key: trigger.check.name
  pattern: app_response
  type: equals
  payload: app_response_check
2016-01-18 17:14:03,433 INFO [-] 0 rule(s) found to enforce for event_handler.
2016-01-18 17:14:03,434 INFO [-] === RULE DOES NOT MATCH ===
</code></pre>
<p>The output identifies that the issue for the specific rule is with the criteria <code>trigger.check.name</code>. Fixing that to match<br>
value from the payload will lead to –</p>
<pre><code># st2-rule-tester --rule=/opt/stackstorm/packs/app_remediation/rules/on_app_response_check.yaml --trigger-instance-id=569882f7aef3392a8c2a834d --config-file=/etc/st2/st2.conf
2016-01-18 17:26:05,415 INFO [-] Connecting to database &quot;st2&quot; @ &quot;0.0.0.0:27017&quot; as user &quot;None&quot;.
2016-01-18 17:26:05,454 INFO [-] Validating rule app_remediation.on_app_response_check for event_handler.
2016-01-18 17:26:05,496 INFO [-] 1 rule(s) found to enforce for event_handler.
2016-01-18 17:26:05,497 INFO [-] === RULE MATCHES ===
</code></pre>
<p>A full description of the capabilities of this tool can be found <a href=https://docs.stackstorm.com/rules.html#testing-rules>here</a>.</p>
<h3 id=what-did-stackstorm-do-with-the-event-that-it-received>What did StackStorm do with the event that it received?</h3>
<p>Once an event-driven automation is setup and StackStorm starts auto-remediation it is often necessary to track<br>
down from source of the external event what StackStorm did with those events. StackStorm enables this through a feature called Trace Tags which allow a user to correlate events originating in external systems with a StackStorm automation.</p>
<p>Trace tags can be attached to TriggerInstances and ActionExecutions. Usually, Sensors or Webhook payloads tend to include trace tags that apply to TriggerInstances, this implies that it is necessary to have an understanding of the Sensor or the configured Webhook payload. Head over to <a href=https://docs.stackstorm.com/traces.html>documentation</a> for an in-depth discussion on Traces.</p>
<p>Continuing with the previously setup example lets begin with a Sensu event. Sensu event payload can be obtained<br>
using the <a href=https://sensuapp.org/docs/latest/api-events>Sensu events API.</a></p>
<p>Sensu event</p>
<pre><code># http http://sensu-server:4567/events

[
    {
        &quot;action&quot;: &quot;create&quot;,
        &quot;check&quot;: {
            ...
        },
        &quot;client&quot;: {
            ...
        },
        &quot;id&quot;: &quot;03cce13d-3dd9-41a8-a357-b1df62ab0705&quot;,
        ...
    }
]
</code></pre>
<p>Each sensu event has a unique <code>id</code> field which is used by the <a href=https://github.com/StackStorm-Exchange/stackstorm-sensu/blob/master/packs/sensu/etc/st2_handler.py>StackStorm Sensu event handler</a> as the Trace Tag for the StackStorm TriggerInstance.</p>
<p>In this case that value is <code>03cce13d-3dd9-41a8-a357-b1df62ab0705</code>. Use this value to obtain a StackStorm Trace.</p>
<pre><code># st2 trace list --trace-tag 03cce13d-3dd9-41a8-a357-b1df62ab0705
id: 5698439eaef3392a8c2a832a
trace_tag: 03cce13d-3dd9-41a8-a357-b1df62ab0705
start_timestamp: 2016-01-15T00:55:58.625104Z
+---------------------------+------------------+----------------------------------+
| id                        | type             | ref                              |
+---------------------------+------------------+----------------------------------+
|  5698439eaef3392a8c2a8329 | trigger-instance | sensu.event_handler              |
|  56983951aef3392ac6e7ba9c | rule             | app_remidiation.on_app_response_ |
|                           |                  | check                            |
| +5698439eaef3392a8c2a832c | execution        | app_remediation.remediate        |
|  5698439faef3392a8c2a832e | trigger-instance | core.st2.generic.actiontrigger   |
+---------------------------+------------------+----------------------------------+
</code></pre>
<p>The above Trace consists a list of activities that StackStorm performed. In this case those are the TriggerInstance created by StackStorm, triggered Rule and ActionExecution representing the performed remediation. Further drill down can be performed using familiar CLI commands like <code>st2 trigger-instance get &lt;trigger-instance-id></code>, <code>st2 rule get &lt;rule-id></code> or <code>st2 execution get &lt;execution-id></code>. This list effectively is the answer to question we started out with i.e. “What did StackStorm do with the event that it received?”.</p>
<h2 id=closing-thoughts>Closing thoughts</h2>
<p>Often the remediation steps in response to an event are not obvious. In those cases StackStorm can be setup to aid with troubleshooting – a practice known as facilitated troubleshooting. By having operators decide the best course of remediation, based on the troubleshooting data gathered by StackStorm, a remediation workflow can then be coded up in StackStorm that replicates trusted manual steps. Facilitated troubleshooting thus becomes a stepping stone to auto-remediation. StackStorm also provides some powerful tools like Flow Workflow editor and GUI based rules editors to aid in authoring of auto-remediations.</p>
<p>With the help of Rules debugging and Traces, StackStorm provides capabilities to quickly build out event-driven automations as well as track the lifetimes of automations. Using StackStorm to maintain and manage your automations helps increase their visibility by making the system observable and traceable leading to increased trust into the automations themselves. Sleep easy, and let StackStorm quash those 2am events for you.</p><ul class=pa0>
</ul>
<div class="mt6 instapaper_ignoref">
</div>
</div>
<aside class="w-30-l mt6-l">
</aside>
</article>
</main>
<footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://stackstorm.github.io/stackstorm.com>
&copy; StackStorm 2021
</a>
<div>
</div>
</div>
</footer>
</body>
</html>