<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>StackStorm and ChatOps Actions with confirmation | StackStorm</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="January 21, 2016
by Igor Cherkaev aka eMptywee
Originally published at http://emptywee.blogspot.com/2016/01/stackstorm-and-chatops-actions-with.html
Before moving to Openstack integration I’d like to post a short article about highly demanded feature, which is going to be implemented and supported natively out of the box by StackStorm one day, – Chatops Action Confirmation.
In short, some actions, requested from chatops, may indeed be dangerous and typo errors or incorrectly entered values may harm your system or lead to unexpected, unpredictable and undesirable results. That being said, it would be really nice to ask the user who issued the command to confirm his or her intentions to execute it.
So for now we have to do it on our own. And I’ll tell you what – it is not really difficult. We will examine two chatops aliases and I will elucidate on the things happening under the hood when these aliases are triggered.">
    <meta name="generator" content="Hugo 0.89.2" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
<link rel="stylesheet" href="/stackstorm.com/ananke/css/main.min.css" >




    
      

    

    
    
    <meta property="og:title" content="StackStorm and ChatOps Actions with confirmation" />
<meta property="og:description" content="January 21, 2016
by Igor Cherkaev aka eMptywee
Originally published at http://emptywee.blogspot.com/2016/01/stackstorm-and-chatops-actions-with.html
Before moving to Openstack integration I’d like to post a short article about highly demanded feature, which is going to be implemented and supported natively out of the box by StackStorm one day, – Chatops Action Confirmation.
In short, some actions, requested from chatops, may indeed be dangerous and typo errors or incorrectly entered values may harm your system or lead to unexpected, unpredictable and undesirable results. That being said, it would be really nice to ask the user who issued the command to confirm his or her intentions to execute it.
So for now we have to do it on our own. And I’ll tell you what – it is not really difficult. We will examine two chatops aliases and I will elucidate on the things happening under the hood when these aliases are triggered." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stackstorm.github.io/stackstorm.com/2016/01/21/stackstorm-and-chatops-actions-with-confirmation/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-01-21T17:28:39+00:00" />
<meta property="article:modified_time" content="2016-01-21T17:28:39+00:00" />

<meta itemprop="name" content="StackStorm and ChatOps Actions with confirmation">
<meta itemprop="description" content="January 21, 2016
by Igor Cherkaev aka eMptywee
Originally published at http://emptywee.blogspot.com/2016/01/stackstorm-and-chatops-actions-with.html
Before moving to Openstack integration I’d like to post a short article about highly demanded feature, which is going to be implemented and supported natively out of the box by StackStorm one day, – Chatops Action Confirmation.
In short, some actions, requested from chatops, may indeed be dangerous and typo errors or incorrectly entered values may harm your system or lead to unexpected, unpredictable and undesirable results. That being said, it would be really nice to ask the user who issued the command to confirm his or her intentions to execute it.
So for now we have to do it on our own. And I’ll tell you what – it is not really difficult. We will examine two chatops aliases and I will elucidate on the things happening under the hood when these aliases are triggered."><meta itemprop="datePublished" content="2016-01-21T17:28:39+00:00" />
<meta itemprop="dateModified" content="2016-01-21T17:28:39+00:00" />
<meta itemprop="wordCount" content="1199">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="StackStorm and ChatOps Actions with confirmation"/>
<meta name="twitter:description" content="January 21, 2016
by Igor Cherkaev aka eMptywee
Originally published at http://emptywee.blogspot.com/2016/01/stackstorm-and-chatops-actions-with.html
Before moving to Openstack integration I’d like to post a short article about highly demanded feature, which is going to be implemented and supported natively out of the box by StackStorm one day, – Chatops Action Confirmation.
In short, some actions, requested from chatops, may indeed be dangerous and typo errors or incorrectly entered values may harm your system or lead to unexpected, unpredictable and undesirable results. That being said, it would be really nice to ask the user who issued the command to confirm his or her intentions to execute it.
So for now we have to do it on our own. And I’ll tell you what – it is not really difficult. We will examine two chatops aliases and I will elucidate on the things happening under the hood when these aliases are triggered."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/stackstorm.com/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        StackStorm
      
    </a>
    <div class="flex-l items-center">
      

      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://stackstorm.github.io/stackstorm.com/2016/01/21/stackstorm-and-chatops-actions-with-confirmation/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://stackstorm.github.io/stackstorm.com/2016/01/21/stackstorm-and-chatops-actions-with-confirmation/&amp;text=StackStorm%20and%20ChatOps%20Actions%20with%20confirmation" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://stackstorm.github.io/stackstorm.com/2016/01/21/stackstorm-and-chatops-actions-with-confirmation/&amp;title=StackStorm%20and%20ChatOps%20Actions%20with%20confirmation" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">StackStorm and ChatOps Actions with confirmation</h1>
      
      <p class="tracked">
          By <strong>
          
              st2admin
          
          </strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2016-01-21T17:28:39Z">January 21, 2016</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p><strong>January 21, 2016</strong><br>
by Igor Cherkaev aka eMptywee</p>
<p>Originally published at <a href="http://emptywee.blogspot.com/2016/01/stackstorm-and-chatops-actions-with.html">http://emptywee.blogspot.com/2016/01/stackstorm-and-chatops-actions-with.html</a></p>
<p>Before moving to Openstack integration I’d like to post a short article about highly demanded feature, which is going to be implemented and supported natively out of the box by StackStorm one day, – Chatops Action Confirmation.</p>
<p>In short, some actions, requested from chatops, may indeed be dangerous and typo errors or incorrectly entered values may harm your system or lead to unexpected, unpredictable and undesirable results. That being said, it would be really nice to ask the user who issued the command to confirm his or her intentions to execute it.</p>
<p>So for now we have to do it on our own. And I’ll tell you what – it is not really difficult. We will examine two chatops aliases and I will elucidate on the things happening under the hood when these aliases are triggered.</p>
<p>Let’s begin and design our <strong>confirmation</strong> action and wrap it into the appropriate action-alias. If you want to quickly deploy the pack with all the actions and aliases right away, you can do so by running the following command:</p>
<pre><code>st2 packs.install packs=st2chat_confirm register=all
repo_url=https://github.com/emptywee/st2chat_confirm.git
</code></pre>
<h3 id="confirm_execmetayaml-metadata-file">confirm_exec.meta.yaml (metadata file)</h3>
<p>When I was experimenting with it, I tried different approaches and initially it was an action-chain. Perhaps, there’s a better way to directly execute <code>st2.kv.set</code> action from the alias, but I haven’t found it yet. Either it’s impossible to do, or it’s poorly documented. All we need to do is pass username of the person who executes the action (triggers the alias). So, we will use a simple action-chain with only one action designed to construct a proper key for the StackStorm data store.</p>
<pre><code>---
# Action definition metadata
name: &quot;confirm_exec&quot;
description: &quot;Confirm action execution&quot;
runner_type: &quot;action-chain&quot;
enabled: true
entry_point: &quot;workflows/confirm_exec.yaml&quot;
parameters:
exec_id:
type: string
required: true
description: &quot;Action execution to confirm&quot;
skip_notify:
default:
- save_key
</code></pre>
<p>We will pass one parameter to the action-chain, which in its turn will pick our chatname and stick it all together as a key. We need to do that because we do not want somebody else to confirm actions that were fired by you.</p>
<h3 id="confirm_execyaml-action-chain">confirm_exec.yaml (action-chain)</h3>
<p>The action chain itself is pretty simple:</p>
<pre><code>---
chain:
    -
        name: &quot;save_key&quot;
        ref: &quot;st2.kv.set&quot;
        params:
            key: &quot;{{action_context.parent.api_user}}_{{exec_id}}&quot;
            value: &quot;confirmed&quot;
            ttl: 60
</code></pre>
<p>That is it for now. The action chain will set a key in the data store for 60 seconds. Now let’s wrap it up with an alias.</p>
<h3 id="confirm_execyaml-alias">confirm_exec.yaml (alias)</h3>
<p>The alias definition is also very simple.</p>
<pre><code>---
name: test.confirm_exec
enabled: true
action_ref: st2chat_confirm.confirm_exec
description: Confirm potentially dangerous execution
formats:
- display: &quot;confirm &lt;execution id=&quot;&quot;&gt;&quot;
representation:
- &quot;confirm {{exec_id}}&quot;
ack:
format: &quot;Confirming action!&quot;
append_url: false
result:
enabled: false
```&lt;/execution&gt;

Feel free to adjust to your own needs here, don’t forget it’s just an example. This alias will trigger the action-chain once you give a command similar to `! confirm 56a01f468e326f6c51a3d4a9`. Of course you can go ahead and replace execution id with some random number or magic word. It doesn’t really matter.

Now, let’s design our potentially dangerous action! I will use mistral workflow as an example, but there should be no problem to use the same approach for _action-chains_. Or should be, since a simple action-chain doesn’t really have mechanisms to implement waiting on user actions. But this is up to you to explore.

### wf_with_confirm.meta.yaml (metadata)

Here’s our metadata for the potentially dangerous action!
</code></pre>
<hr>
<p>description: “test wf with confirm from chatops”<br>
runner_type: “mistral-v2”<br>
tags: []<br>
enabled: true<br>
pack: “st2chat_confirm”<br>
entry_point: “workflows/wf_with_confirm.yaml”<br>
uid: “action:st2chat_confirm:wf_with_confirm”<br>
parameters:<br>
hostlist:<br>
required: true<br>
type: “string”<br>
description: “a list of hosts”<br>
param1:<br>
default: “”<br>
type: “string”<br>
description: “Some parameter”<br>
ref: “st2chat_confirm.wf_with_confirm”<br>
name: “wf_with_confirm”</p>
<pre><code>&lt;br /&gt;In this example we are doing something (literally **doing something**!) to a list of hosts. Therefore, we will need to confirm it! We will pass a list of host names as hostlist and some arbitrary parameter `param1`.

The workflow itself is represented on the diagram below.

![http://stackstorm.com/wp/wp-content/uploads/2016/01/flow_diagram.jpg](http://stackstorm.com/wp/wp-content/uploads/2016/01/flow_diagram.jpg)

Let’s go step by step over the workflow.

* First step here is to publish a few variables which we’ll refer to later, this step is optional and is placed here only for convenience. We publish `chat_user`, `source_channel`, and `exec_id` variables here. You will see why later;
* Second step is there to throw a message into the channel asking the user to confirm the action execution;
* Next, we wait for about 30 seconds for the action to get confirmed, and if it’s confirmed we take the execution one way, if it’s not – the other way;

Yes, it’s that simple. This workflow can be used a starting point for every dangerous action you design. I think that we can even pass a name of the desired workflow to get executed **after** confirmation. That way we won’t have to copy and paste the same code in each such action. Code re-use is a really good thing to always keep it in mind.

### wf_with_confirm.yaml (workflow)

The mistral workflow itself is quite simple as well:
</code></pre>
<hr>
<p>version: ‘2.0’</p>
<p>e_playground.wf_with_confirm:<br>
type: direct<br>
input:<br>
– hostlist<br>
– param1<br>
tasks:<br>
publish_data:</p>
<h1 id="297-28">[297, 28]</h1>
<p>action: core.noop<br>
publish:<br>
chat_user: &lt;% env().get('<em>_actions').get(&lsquo;st2.action&rsquo;).st2_context.parent.api_user %&gt;<br>
source_channel: &lt;% env().get('</em>_actions').get(&lsquo;st2.action&rsquo;).st2_context.parent.source_channel %&gt;<br>
exec_id: &lt;% env().get('__actions').get(&lsquo;st2.action&rsquo;).st2_context.parent.execution_id %&gt;<br>
on-success:<br>
– post_confirm_message<br>
post_confirm_message:</p>
<h1 id="286-163">[286, 163]</h1>
<p>action: chatops.post_message<br>
input:<br>
channel: ‘&lt;% $.source_channel %&gt;‘<br>
message: ‘@&lt;% $.chat_user %&gt;, the action you have requested is dangerous. Please, confirm by issuing “! confirm &lt;% $.exec_id %&gt;” command. You have 30 seconds to confirm it.’</p>
<p>on-success:<br>
– wait_for_confirmation<br>
wait_for_confirmation:</p>
<h1 id="286-304">[286, 304]</h1>
<p>action: st2.kv.get<br>
input:<br>
key: ‘&lt;% $.chat_user %&gt;_&lt;% $.exec_id %&gt;‘</p>
<p>retry:<br>
count: 10<br>
delay: 3</p>
<p>on-error:<br>
– post_not_confirmed<br>
on-success:<br>
– post_confirmed<br>
post_not_confirmed:</p>
<h1 id="456-434">[456, 434]</h1>
<p>action: chatops.post_message<br>
input:<br>
channel: ‘&lt;% $.source_channel %&gt;‘<br>
message: ‘@&lt;% $.chat_user %&gt;, I have not received confirmation from you within 30 seconds. The execution has been aborted.’</p>
<p>post_confirmed:</p>
<h1 id="97-445">[97, 445]</h1>
<p>action: chatops.post_message<br>
input:<br>
channel: ‘&lt;% $.source_channel %&gt;‘<br>
message: ‘@&lt;% $.chat_user %&gt;, The action is confirmed. Proceeding…’</p>
<pre><code>&lt;br /&gt;Take a look at the first task there. Notice the long path to the variables we need. Perhaps, there’s a better way to get to them and store them, but I couldn’t figure it out yet. If you did, please, share in the comments section below.

Key aspect here (why we actually use mistral workflow) is the `retry` section of the `wait_for_confirmation task`. Mistral allows you to retry the task for a set amount of attempts. Thus, setting 10 attempts with a 3-second delay gives us about 30 seconds to confirm the action.

Last touch would be wrapping it up in an `action-alias`.

### test.yaml (alias)
</code></pre>
<hr>
<p>name: st2chat_confirm.wf_with_confirm<br>
enabled: true<br>
action_ref: st2chat_confirm.wf_with_confirm<br>
description: Test workflow with confirm. Starting point.<br>
formats:<br>
– display: “do_something with <!-- raw HTML omitted --> <!-- raw HTML omitted -->”<br>
representation:<br>
– “do_something with {{hostlist}} {{param1}}”<br>
result:<br>
format: |<br>
Execution ID {{ execution.id }} complete.<br>
“`<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="in-the-end">In the end</h3>
<p>Reloading everything and trying to fire up the potentially dangerous action we have just created!<br>
To reload actions and aliases metadata simply issue the following command:</p>
<pre><code>st2ctl reload --register-all
</code></pre>
<p><img src="http://stackstorm.com/wp/wp-content/uploads/2016/01/chat_example.jpg" alt="http://stackstorm.com/wp/wp-content/uploads/2016/01/chat_example.jpg"></p>
<p>Ta-dam!</p>
<p>GitHub repository is located here: <a href="https://github.com/emptywee/st2chat_confirm">https://github.com/emptywee/st2chat_confirm</a></p>
<p>Feel free to ask questions if you have any. As always, you are welcome to join the friendly and super-fast responding Stackstorm community at <a href="https://stackstorm.com/community/">https://stackstorm.com/community/</a></p>
<p>Also, I’d recommend trying the StackStorm Enterprise Edition. It gives you that beautiful visual workflow editor and support from the StackStorm core team.</p><ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://stackstorm.github.io/stackstorm.com" >
    &copy;  StackStorm 2021 
  </a>
    <div>














</div>
  </div>
</footer>

  </body>
</html>
