<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Managing AWS Instance Lifecycle With StackStorm | StackStorm</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="January 13, 2015
by Patrick Hoolboom
Introduction
The StackStorm community repo has a rich integration pack for EC2 and Route53 action that you can find inside the StackStorm Exchange. These actions are incredibly useful but they are just the building blocks. The real power of using StackStorm actions comes when they are stitched together into workflows. I’ve taken the two basic workflows we use for EC2 instance lifecycle management and genericized them, then added them to the AWS integration pack. I’m going to go over how these can be used to greatly simplify creation and termination of instances.
Why?
At StackStorm we needed a way to rapidly provision VMs that had all of our bootstrapping done…and it had to be easy to do from the command line or StackStorm UI. This version of the workflow has been simplified to remove some of our internal bootstrapping steps but still reduces the entire process of instance creation, DNS registration, and basic bootstrapping to a single command.">
    <meta name="generator" content="Hugo 0.89.2" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
<link rel="stylesheet" href="/stackstorm.com/ananke/css/main.min.css" >




    
      

    

    
    
    <meta property="og:title" content="Managing AWS Instance Lifecycle With StackStorm" />
<meta property="og:description" content="January 13, 2015
by Patrick Hoolboom
Introduction
The StackStorm community repo has a rich integration pack for EC2 and Route53 action that you can find inside the StackStorm Exchange. These actions are incredibly useful but they are just the building blocks. The real power of using StackStorm actions comes when they are stitched together into workflows. I’ve taken the two basic workflows we use for EC2 instance lifecycle management and genericized them, then added them to the AWS integration pack. I’m going to go over how these can be used to greatly simplify creation and termination of instances.
Why?
At StackStorm we needed a way to rapidly provision VMs that had all of our bootstrapping done…and it had to be easy to do from the command line or StackStorm UI. This version of the workflow has been simplified to remove some of our internal bootstrapping steps but still reduces the entire process of instance creation, DNS registration, and basic bootstrapping to a single command." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stackstorm.github.io/stackstorm.com/2015/01/14/managing-aws-instance-lifecycle-with-stackstorm/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-01-14T00:38:05+00:00" />
<meta property="article:modified_time" content="2015-01-14T00:38:05+00:00" />

<meta itemprop="name" content="Managing AWS Instance Lifecycle With StackStorm">
<meta itemprop="description" content="January 13, 2015
by Patrick Hoolboom
Introduction
The StackStorm community repo has a rich integration pack for EC2 and Route53 action that you can find inside the StackStorm Exchange. These actions are incredibly useful but they are just the building blocks. The real power of using StackStorm actions comes when they are stitched together into workflows. I’ve taken the two basic workflows we use for EC2 instance lifecycle management and genericized them, then added them to the AWS integration pack. I’m going to go over how these can be used to greatly simplify creation and termination of instances.
Why?
At StackStorm we needed a way to rapidly provision VMs that had all of our bootstrapping done…and it had to be easy to do from the command line or StackStorm UI. This version of the workflow has been simplified to remove some of our internal bootstrapping steps but still reduces the entire process of instance creation, DNS registration, and basic bootstrapping to a single command."><meta itemprop="datePublished" content="2015-01-14T00:38:05+00:00" />
<meta itemprop="dateModified" content="2015-01-14T00:38:05+00:00" />
<meta itemprop="wordCount" content="971">
<meta itemprop="keywords" content="devops,tutorial," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Managing AWS Instance Lifecycle With StackStorm"/>
<meta name="twitter:description" content="January 13, 2015
by Patrick Hoolboom
Introduction
The StackStorm community repo has a rich integration pack for EC2 and Route53 action that you can find inside the StackStorm Exchange. These actions are incredibly useful but they are just the building blocks. The real power of using StackStorm actions comes when they are stitched together into workflows. I’ve taken the two basic workflows we use for EC2 instance lifecycle management and genericized them, then added them to the AWS integration pack. I’m going to go over how these can be used to greatly simplify creation and termination of instances.
Why?
At StackStorm we needed a way to rapidly provision VMs that had all of our bootstrapping done…and it had to be easy to do from the command line or StackStorm UI. This version of the workflow has been simplified to remove some of our internal bootstrapping steps but still reduces the entire process of instance creation, DNS registration, and basic bootstrapping to a single command."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/stackstorm.com/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        StackStorm
      
    </a>
    <div class="flex-l items-center">
      

      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://stackstorm.github.io/stackstorm.com/2015/01/14/managing-aws-instance-lifecycle-with-stackstorm/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://stackstorm.github.io/stackstorm.com/2015/01/14/managing-aws-instance-lifecycle-with-stackstorm/&amp;text=Managing%20AWS%20Instance%20Lifecycle%20With%20StackStorm" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://stackstorm.github.io/stackstorm.com/2015/01/14/managing-aws-instance-lifecycle-with-stackstorm/&amp;title=Managing%20AWS%20Instance%20Lifecycle%20With%20StackStorm" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Managing AWS Instance Lifecycle With StackStorm</h1>
      
      <p class="tracked">
          By <strong>
          
              st2admin
          
          </strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2015-01-14T00:38:05Z">January 14, 2015</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p><strong>January 13, 2015</strong></p>
<p><em>by Patrick Hoolboom</em></p>
<h6 id="introduction">Introduction</h6>
<p>The StackStorm community repo has a rich integration pack for EC2 and Route53 action that you can find inside the <a href="https://exchange.stackstorm.org/">StackStorm Exchange</a>. These actions are incredibly useful but they are just the building blocks. The real power of using StackStorm actions comes when they are stitched together into workflows. I’ve taken the two basic workflows we use for EC2 instance lifecycle management and genericized them, then added them to the AWS integration pack. I’m going to go over how these can be used to greatly simplify creation and termination of instances.</p>
<h6 id="why">Why?</h6>
<p>At StackStorm we needed a way to rapidly provision VMs that had all of our bootstrapping done…and it had to be easy to do from the command line or StackStorm UI. This version of the workflow has been simplified to remove some of our internal bootstrapping steps but still reduces the entire process of instance creation, DNS registration, and basic bootstrapping to a single command.</p>
<h6 id="in-a-hurry">In a Hurry?</h6>
<p>The following gets in to the nuts and bolts of how the workflows operate but if you are in a hurry, you can start managing your AWS instance lifecycle with StackStorm by following the requirements section below.</p>
<h6 id="requirements">Requirements</h6>
<p>The workflows used here will require StackStorm to be running and for the following packs to be installed:</p>
<ul>
<li>linux</li>
<li>aws</li>
</ul>
<p>The Linux pack is installed by default. We just need to add the AWS pack:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>This will install the integration packs from the community repo and do the initial set up. You will still need to add a set of AWS credentials and default region to the config file. Assuming your packs are installed in the default location, the config file can be found here:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>You will need to update these lines:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Once you’ve added your account info, and run <code>sudo st2ctl reload --register-configs</code> you should be able to run any of the AWS actions.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>The AWS integration pack is now configured and ready to be used.</p>
<h6 id="user-data">User Data</h6>
<p>The pack has a concept of a default user data file. This gives a simple way of bootstrapping new nodes with the StackStorm system user so further tasks can easily be managed from the platform. The pack ships with the following script at aws/actions/scripts/bootstrap_user.sh</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Edit this script to add the public key for the StackStorm user in the PUBKEY variable. By default, this can be found at/home/stanley/.ssh/stanley_rsa.pub</p>
<p>You can use any script you would like here, but these steps are crucial to bootstrapping the StackStorm user for remote administration.</p>
<h6 id="create-vm-workflow">Create VM Workflow</h6>
<p>With the setup out of the way we can dive in to the instance creation workflow. There are a few assumptions made in this workflow.</p>
<ol>
<li>Your DNS is managed via Route53</li>
<li>You are deploying a vanilla linux server</li>
<li>The StackStorm server has access to the private IP address of the new instance.</li>
</ol>
<p>The create_vm action metadata:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Notice all of the required fields. We start off with no defaults for those, but I will show you how to make running these actions much easier later on.</p>
<p>The create_vm workflow:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>The steps of the workflow are as follows:</p>
<ol>
<li>Run a new instance</li>
<li>Wait for the instance state to switch to ‘running’</li>
<li>Wait for SSH to succeed, using the default user for the distro (set to ubuntu by default)</li>
<li>Add a tag that matches the hostname</li>
<li>Add the CNAME to the Route53 zone specified at run time</li>
<li>Set the hostname on the instance and enable preserver_hostname in cloud.cfg</li>
<li>Reboot and wait for the server to come back up</li>
<li>Run the workflow</li>
</ol>
<p>To run the workflow using the standard action params, the command will look something like this:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>The important parts of this are:</p>
<ul>
<li>dns_zone – The zone to add the CNAME to</li>
<li>key_name – The key_name as listed by:st2 run aws.ec2_get_all_key_pairs</li>
<li>keyfile – local path to the private key that will be used to verify SSH connectivity</li>
<li>image_id – The image_id above is a trusty tahr image. If you wish to use a different distro, this will need to be changed.</li>
</ul>
<p>Once the workflow runs you can check the status with:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>When completed the output should look something like this:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>As you can see above all 9 steps in the workflow completed successfully. Assuming DNS is setup correctly in your environment you should now be able to look up the host you just created, as well run StackStorm commands against it:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h6 id="destroy-vm-workflow">Destroy VM Workflow</h6>
<p>The destroy_vm workflow is designed to terminate an instance based on hostname. The definition of the workflow is below:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>The workflow performs the following steps:</p>
<ol>
<li>Looks up the CNAME of the host</li>
<li>Get a list of instances</li>
<li>Filter out the ID of the instance with the appropriate internal dns name.</li>
<li>Terminate the instance</li>
<li>Delete the CNAME entry in Route53</li>
</ol>
<p>The metadata for this action is fairly straight forward:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>The only parameters necessary are dns_zone and hostname. If we run this workflow against our newly created host like so:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>The output of execution list after running this should look like this:</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h6 id="next-steps">Next Steps</h6>
<p>The workflows as they are written have made provisioning and decommissioning VMs significantly easier. There are a number of other ways we can speed up this process and make them more easily reproducible. The easiest is to define defaults for many of the parameters for the workflows.</p>
<h6 id="create-vm">Create VM</h6>
<p>In order to simplify the command for the create vm workflow you can define defaults for most of the paramaters. The simplest would be these:</p>
<ul>
<li>image_id</li>
<li>key_name</li>
<li>keyfile</li>
<li>dns_zone</li>
<li>subnet_id</li>
</ul>
<h6 id="destroy-vm">Destroy VM</h6>
<p>The destroy VM workflow doesn’t have as many parameters but it can be simplified by setting a default for:</p>
<ul>
<li>dns_zone</li>
</ul>
<h6 id="improvements">Improvements</h6>
<p>In the next blog I will show some ways to improve these workflows using the StackStorm datastore, and adding additional steps for things like adding apt repos or bootstrapping Puppet.</p><ul class="pa0">
  
   <li class="list">
     <a href="/stackstorm.com/tags/devops" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">devops</a>
   </li>
  
   <li class="list">
     <a href="/stackstorm.com/tags/tutorial" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">tutorial</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/stackstorm.com/2014/12/22/monitor-twitter-and-fire-automations-based-on-twitter-keywords-using-stackstorm/">Monitor Twitter And Fire Automations Based On Twitter Keywords Using StackStorm</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/stackstorm.com/2014/08/11/devopsdays-presentation-devops-greatest-shift-industry/">DevOpsDays Presentation: Why DevOps Is The Greatest Shift In The IT Industry</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/stackstorm.com/2014/07/31/look-back-successes-openstack-emerging-challenges/">A Look Back At The Successes Of OpenStack, And Some Emerging Challenges</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://stackstorm.github.io/stackstorm.com" >
    &copy;  StackStorm 2021 
  </a>
    <div>














</div>
  </div>
</footer>

  </body>
</html>
